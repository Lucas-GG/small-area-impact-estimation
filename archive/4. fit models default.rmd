```{r}
library(data.table)
library(parallel)
#load R functions
sapply(list.files("R/", ".r", full.names = TRUE), source)
set.seed(0203)
options(scipen = 10^6)

dt_list <- readRDS(file = paste0("data/placebo.rds"))
```

```{r}
fit_ols <- function(dt_tmp) {
  twfe <- lm(SMR ~ x + factor(id) + factor(time)
  , data = dt_tmp[dt_tmp$O == 1, ])
  dt_tmp$SMR0 <- predict(twfe, dt_tmp)
  dt_tmp$method <- "twfe"
  dt_tmp
}
```


default methods
```{r}
dt_tmp <- dt_list[[2]]
new_dt <- fit_ols(dt_tmp)
new_dt

start_time <- Sys.time()
list_dat <- mclapply(dt_list, \(dt) {
    j <- unique(dt$tag)
    pred     <-  tryCatch(fit_ols(dt)
               ,  error = function(c) NULL)
    print(j)
    pred
    }
    , mc.cores = 20
    )
end_time <- Sys.time()
end_time - start_time
ols_fits   <- rbindlist(list_dat)

saveRDS(ols_fits, file = paste0("data/p_ols_fits.rds"))
```