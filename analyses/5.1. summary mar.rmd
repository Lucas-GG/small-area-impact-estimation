```{r}
library(data.table)
library(tidyverse)
library(parallel)
options(digitis = 3)
options(scipen = 10^5) 
options(help_type = "html")

#load R functions
sapply(list.files("R/", ".r", full.names = TRUE), source)
set.seed(0203)
options(scipen = 10^6)


library(gt)
```


```{r}
ae <- \(y, y0) abs(y - y0)
se <- \(y, y0) (y - y0)^2
sae <- \(y, y0, n) abs((y - y0) / n * 10^5)
sse <- \(y, y0, n) ((y - y0) /  n * 10^5)^2


#coverage
cvg <- \(y, l, u) as.numeric(l <= y & y <= u)

#interval score 
intv <- \(y, l, u, α = .05) {
  (u - l) + 2 / α * (l - y) * (y < l) + 2 / α * (y - u) * (y > u)
}


#Poisson deviance
d2 <- \(y, y0) {
  ifelse(y > 0
    , 2 * (y * log(y / y0) + y0 - y)
    , 2 * y0
  )
}

#Dawid–Sebastiani score
ds <- \(y, y0, y0_sd) {
  sigpred <- sqrt(y0 + y0_sd^2)
  ((y - y0) / sigpred) ^ 2 + 2 * log(sigpred)
}

#Dawid–Sebastiani score
#depedns only on mean and SE (or poserior SD)
#*** Becouse the true att is zero att = bias
score <- \(m) {
  m %>%
    mutate(
      , d = Y - y0_hat
      , ae = ae(Y, y0_hat)
      , se = se(Y, y0_hat)
      , sae = sae(Y, y0_hat, n)
      , sse = sse(Y, y0_hat, n)
      , d2 = d2(Y, y0_hat)
      , lns = log(y0_pi)
      , ds = ds(Y, y0_hat, y0_sd)
      , cvg = cvg(Y, y0_lower, y0_upper)
      , intv = intv(Y, y0_lower, y0_upper)
      , sigpred = y0_hat + y0_sd^2
    ) %>%
    reframe(
      across(c(d:sigpred)
        , \(x) mean(x, na.rm = TRUE)
      )
      , se = sqrt(se)
      , sse = sqrt(sse)
      , sigpred = sqrt(sigpred)
      , pcor = cor(Y, y0_hat, use = "complete.obs")
      , scor = cor(Y, y0_hat, method = "spearman", use = "complete.obs")
    )
}

score0 <- \(m) {
  m %>%
    mutate(
      , d = Y - y0_hat
      , ae = ae(Y, y0_hat)
      , se = se(Y, y0_hat)
      , d2 = d2(Y, y0_hat)
    ) %>%
    reframe(
      across(c(d, ae, se, d2)
        , \(x) mean(x, na.rm = TRUE)
      )
      , se = sqrt(se)
      , pcor = cor(Y, y0_hat, use = "complete.obs")
      , scor = cor(Y, y0_hat, method = "spearman", use = "complete.obs")
    )
}


```

```{r}
head(fits)
table(is.na(fits$Y0))

forest_fit <- readRDS("data/forest_fit_mar.rds")
mex_fit <- readRDS("data/mex_fit_mar0.rds")
spx_fit <- readRDS("data/spx_fit_mar0.rds")
arx_fit <- readRDS("data/arx_fit_mar0.rds")
twfe_fit <- readRDS("data/twfe_fit_mar.rds")
etwfe_fit <- readRDS("data/etwfe_fit_mar.rds")

fits <- list(forest_fit, mex_fit, me_inla_fit, arx_fit, spx_fit, twfe_fit, etwfe_fit)
```

```{r}
scored_fits <- lapply(fits, \(fit) {
  fit %>%
    filter(is.na(y0)) %>% #@$%^#@!
    group_by(method, replication) %>%
    score
}) %>% bind_rows


rlbs <- c("forest", "mex", "me_inla"
  , "arx_inla", "spx_inla", "twfe", "etwfe"
)
lbs <- c("basic", "mixed effect", "me_inla"
  , "ar(1)", "st", "twfe", "etwfe"
)

scored_fits %>%
  mutate(method = factor(method, levels = rlbs, labels = lbs)) %>%
  group_by(method) %>%
  reframe(mutate(
    across(c(d:scor), \(x) mean(x))#list(m = mean, sd = sd))
  )) %>%
  gt %>%
  fmt_number(columns = where(is.numeric), decimals = 3)  #%>%
 # gtsave("output/all_mar.html")
```

```{r}
scored_fits_noncore <- lapply(fits, \(fit) {
  fit %>%
    filter(is.na(y0) & urb == "6.NonCore") %>%
    group_by(method, replication) %>%
    score
}) %>% bind_rows

scored_fits_noncore %>%
  mutate(method = factor(method, levels = rlbs, labels = lbs)) %>%
  group_by(method) %>%
  reframe(mutate(
    across(c(d:scor), \(x) mean(x))#list(m = mean, sd = sd))
  )) %>%
  gt %>%
  fmt_number(columns = where(is.numeric), decimals = 3) #%>%
  #gtsave("output/noncore_mar.html")
```





```{r}
lbs <- c(
  "basic"
  , "mixed effect"
  , "me_inla"
  , "ar(1)"
  , "spatiotemporal"
  , "wfe"
  , "etwfe"
)
lbs <- stringr::str_wrap(lbs, 20)
```

plots
```{r}
myv <- \(data, map = aes(x = method, y = cor)
  , transf = "exp"
  , ylab = "correlation"
) {
  data %>%
    filter(method != "ME w/ INLA") %>%
    ggplot(map) +
    geom_violin(aes(col =  method), show.legend = FALSE) +
    stat_summary(geom = "errorbar"
      , width = .15
      , linewidth = 1
      , fun.min = median
      , fun.max = median
    ) +
    stat_summary(geom = "errorbar"
      , width = .15
      , fun = median
      , fun.min = \(x) quantile(x, .25)
      , fun.max = \(x) quantile(x, .75)
    ) +
    scale_y_continuous(trans = transf) +
    xlab("") + ylab(ylab) +
    theme_minimal() #+
    #theme(axis.text.x = element_text(size = 12))
}
```

DSS
```{r}
tapply(pl_tb$dss, pl_tb$method, min)

myv(scored_fits
  , aes(x = method, y = dss), "identity", "Dawid–Sebastiani score"
)

png("output/dss_all.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
myv(pl_tb, aes(x = method, y = dss), "identity", "Dawid–Sebastiani score")

dev.off()

tapply(pl_tb_urb$dss, pl_tb_urb$method, min)
pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = dss), transf = "identity", "Dawid–Sebastiani score")

png("output/dss_ncore.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = dss), transf = "identity", "Dawid–Sebastiani score")
dev.off()
```


plot bias
```{r}

myv(pl_tb, aes(x = method, y = att^2), "log10")

png("output/bias_all.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
myv(pl_tb, aes(x = method, y = att^2), "log10")
dev.off()


pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y =  att^2), transf = "log10")

png("output/bias_ncore.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y =  att^2), transf = "log10")
dev.off()
```



plot error
```{r}
myv(pl_tb, aes(x = method, y = aes), "log10")

png("output/ae_all.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
myv(pl_tb, aes(x = method, y = aes), "log10")
dev.off()

pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y =  aes), transf = "log10")


png("output/ae_ncore.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = aes), transf = "log10")
dev.off()
```



plot corr
```{r}
myv(pl_tb, aes(x = method, y = cor))

png("output/cor_all.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
myv(pl_tb, aes(x = method, y = cor))
dev.off()

pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = cor))


png("output/cor_ncore.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = cor))
dev.off()
```


plot cvg
```{r}
myv(pl_tb, aes(x = method, y = cvg))

pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = cvg))

png("output/cvg_all.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
myv(pl_tb, aes(x = method, y = cvg))
dev.off()



png("output/cvg_ncore.png"
  , width = 480 * 5, heigh = 480 * 3, res = 300)
pl_tb_urb %>%
  filter(urb == "6.NonCore") %>%
  myv(aes(x = method, y = cvg))
dev.off()
```


```{r}
fits %>%
  filter(method == "re") %>%
  group_by(urb) %>%
  reframe(
    smr = mean(Y / E)
    , smr_se = mean(sqrt(smr / E))
    , y_se = mean(sqrt(smr * E))
  )

fits %>%
  filter(method == "re") %>%
  group_by(urb) %>%
  reframe(
    smr = mean(Y / E)
    , smr_se = mean(sqrt(smr / E))
    , y_se = mean(sqrt(smr * E))
  )

fits %>%
  group_by(method, urb) %>%
  filter(urb == "6.NonCore") %>%
  reframe(mean(sigma))

```