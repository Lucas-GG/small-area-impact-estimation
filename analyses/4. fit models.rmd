

```{r}
options(digitis = 3)
options(scipen = 10^5)
options(help_type = "html")
library(data.table)
library(tidyverse)
library(parallel)
#load R functions
sapply(list.files("R/", ".r", full.names = TRUE), source)
set.seed(0203)
options(scipen = 10^6)


library(INLA)
library(fixest)
library(parallel)
```

DATA
```{r}
#dt_list <- readRDS(file = paste0("data/placebo_1124.rds"))
#dt_list <- readRDS("data/placebo_nox_1224.rds")
placebo_dt <- readRDS("data/placebo_dt_0125.rds")
load("data/W")
rownames(W) <- NULL
```

#sp we
```{r}
t0 <- Sys.time()
set.seed(0203)
spx_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_spx
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(spx_fit, "data/spx_fit.rds")
```

#sp we
```{r}
t0 <- Sys.time()
set.seed(0203)
spwe_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_spwe
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

spwe_fit %>%
  group_by(replication) %>%
  filter(is.na(y0)) %>%
  score

saveRDS(spwe_fit, "data/spwe_fit.rds")
```


#spatial only
```{r}
t0 <- Sys.time()
set.seed(0203)
sx_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_sx
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(sx_fit, "data/sx_fit.rds")
```

inla me
```{r}
t0 <- Sys.time()
set.seed(0203)
me_inla_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_me_inla
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(me_inla_fit, "data/me_inla_fit.rds")
```

AR(1)
```{r}
t0 <- Sys.time()
set.seed(0203)
arx_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_arx
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(arx_fit, "data/arx_fit.rds")
```

```{r}
t0 <- Sys.time()
set.seed(0203)
rirw_inla_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_rirw_inla
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(rirw_inla_fit, "data/rirw_inla_fit.rds")
```

#ME
```{r}
#filter(placebo_dt, replication == 1) %>% fit_me(2) %>% score

t0 <- Sys.time()
set.seed(0203)
me_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_me(200)
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

me_fit %>%
  group_by(replication) %>%
  filter(is.na(y0)) %>%
  score

saveRDS(me_fit, "data/me_fit.rds")
```

#Fixed effects
```{r}
t0 <- Sys.time()
set.seed(0203)
fm <- formula(y0 ~ 1 | i + year)
twfe_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_fe(200)
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
twfe_fit$method <- "twfe"
saveRDS(twfe_fit, "data/twfe_fit.rds")

# this is alrread a CRE model
# we are intrest in the effect of intervention,
# worried about heterogeneity
# so we include a cluster level average of the covariate (which is the same as the cohort indicator)

t0 <- Sys.time()
set.seed(0203)
fm <- formula(y0 ~ 1 | start_year + year)
etwfe_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_fe(200)
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
etwfe_fit$method <- "etwfe"
saveRDS(etwfe_fit, "data/etwfe_fit.rds")
```

correlated RE
when you fit this extended regression using the RE estimator,
you obtain the same coefficients for time-varying regressors as if you had used an FE estimator
Should wew include mean (year)
```{r}
# mutate(m_yr = mean(ifelse(is.na(y0), scale(year), NA), na.rm = TRUE))

t0 <- Sys.time()
set.seed(0203)
fm <- formula(y0 ~ offset(log(n))
  +  relevel(factor(start_year), ref = 2) + scale(year) + (scale(year) | i)
)
cre_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_me
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
cre_fit$method <- "cre"
saveRDS(cre_fit, "data/cre_fit.rds")
```

with predictor as offset
```{r}
# mutate(m_yr = mean(ifelse(is.na(y0), scale(year), NA), na.rm = TRUE))
head(placebo_dt$y0_hat)

t0 <- Sys.time()
set.seed(0203)
fm <- formula(y0 ~ offset(log(y0_hat)) + (1 | i))
#filter(placebo_dt, replication == 1) %>% fit_me(2)

mex_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_me
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
mex_fit$method <- "mex"
saveRDS(mex_fit, "data/mex_fit.rds")
```

***------------------------------------------------------------***
***fit functions***
***------------------------------------------------------------***
simplest
```{r}
library(fixest)

.data <- NULL
#.data <- filter(placebo_dt, replication == 1)
#.data %>% impute_etwfe
#.data %>% fit_fe(3) %>% score
boot_fe <- \(.data, impute, nboot = 200) {
  lapply(1:nboot, \(i) {
    .data$wts <- NULL
    .wdata <- left_join(
      .data
      , data.frame(i = unique(.data$i), wts = bb(n_distinct(.data$i)))
      , by = "i"
    )
    .wdata %>% mutate(wts = .wdata$wts / sum(.wdata$wts) * nrow(.wdata)) %>%
      impute
  }) %>%
    do.call("cbind", .)
}

impute_fe <- \(.data) {
  if (is.null(.data$wts)) .data$wts <- 1
  fepois(fm
    , vcov = ~ i, offset = ~ log(n)
    , .data, weights = .data$wts
  ) %>% predict(.data, type = "response")
}

fit_fe <- \(.data, nboot = 200) {
  t0 <- Sys.time()
  .data$y0_hat <- .data %>% impute_fe
  .data$y0_post <- .data %>% boot_etwfe(impute_fe, nboot)

  .data$y0_sd <- apply(.data$y0_post, 1, sd)
  .data$eta_mean <- log(.data$y0_hat)
  .data$eta_sd <- apply(log(.data$y0_post), 1, sd)
  .data$y0_pi <- with(.data, pi_poilog(Y, eta_mean, eta_sd))
  .data[, c("y0_lower", "y0_upper")] <-
    with(.data, ci_poilog(eta_mean, eta_sd))
  t1 <- Sys.time()
  print(t1 - t0)
  .data
}
```

ME
```{r}
library(lme4)

#fm <- formula(Y0 ~ offset(log(n)) + x + (x - 1 | id) + (1 | fyr))
fm <- formula(y0 ~ offset(log(n)) + scale(year) + (scale(year) | i))

boot_me <- \(.data, nboot = 200) {
  lapply(1:nboot, \(i) {
    .data$wts <- NULL
    .wdata <- left_join(
      .data
      , data.frame(i = unique(.data$i), wts = bb(n_distinct(.data$i)))
      , by = "i"
    )
    .wdata %>% mutate(wts = .wdata$wts / sum(.wdata$wts) * nrow(.wdata)) %>%
      impute_me
  }) %>%
    do.call("cbind", .)
}

.data <- filter(placebo_dt, replication == 1)
.data$wts <- 1
impute_me <- \(.data) {
  if (is.null(.data$wts)) .data$wts <- 1
  glmer(fm
    , family = "poisson"
    , .data, weights = wts
    , control=glmerControl(optimizer = "bobyqa")#, optCtrl = list(maxfun  = 2e5))
  ) %>% predict(.data, type = "response")
}


fit_me <- \(.data, nboot = 200) {
  t0 <- Sys.time()
  .data$y0_hat <- .data %>% impute_me
  .data$y0_post <- .data %>% boot_me(nboot)
  .data$y0_sd <- apply(.data$y0_post, 1, sd)
  .data$eta_mean <- log(.data$y0_hat)
  .data$eta_sd <- apply(log(.data$y0_post), 1, sd)
  .data$y0_pi <- with(.data, pi_poilog(Y, eta_mean, eta_sd))
  .data[, c("y0_lower", "y0_upper")] <-
    with(.data, ci_poilog(eta_mean, eta_sd))
  .data$method <- "me"
  t1 <- Sys.time()
  print(t1 - t0)
  .data
}

filter(placebo_dt, replication == 1) %>% fit_me(2) %>% score
filter(placebo_dt, replication == 2) %>% fit_me(2) %>% score
#.data %>% impute_me
#.data %>% boot_me(3)
#.data %>% fit_me(2) %>% filter(is.na(y0)) %>% score
#.data %>% fit_me(3) %>% filter(is.na(y0)) %>% score
```


```{r}
fit_spwe <- \(.data
  , nboot = 200, compute_we = TRUE
) {
  t0 <- Sys.time()
  if (compute_we)
    graph <- W_est(.data, W)
  else
    graph <- W
  .data$time <- as.numeric(factor(.data$year))
  .data$time2 <- .data$time
  model <- inla(y0 ~ offset(log(n))
    + f(time2, model = "rw1")
    + f(i, model = "besagproper2", graph = graph
      , group = time, control.group = list(model = "ar1")
    )
    , family = "poisson"
    , data = .data
    , control.predictor = list(link = 1)
    , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
      , config = TRUE
    )
  )
  #summary(model)
  .data <- append_results(model, .data, nboot)
  .data$method <- "spwe_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  return(.data)
}
```


```{r}
fit_spx <- \(.data
  , nboot = 200, compute_we = TRUE
) {
  t0 <- Sys.time()
  if (compute_we)
    graph <- W_est(.data, W)
  else
    graph <- W
  .data$time <- as.numeric(factor(.data$year))
  .data$time2 <- .data$time
  model <- inla(y0 ~ offset(log(y0_hat))
    + f(i, model = "besagproper2", graph = graph
      , group = time, control.group = list(model = "ar1")
    )
    , family = "poisson"
    , data = .data
    , control.predictor = list(link = 1)
    , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
      , config = TRUE
    )
  )
  #summary(model)
  .data <- append_results(model, .data, nboot)
  .data$method <- "spx_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  return(.data)
}
```

```{r}
fit_sx <- \(.data
  , nboot = 200, compute_we = TRUE
) {
  t0 <- Sys.time()
  if (compute_we)
    graph <- W_est(.data, W)
  else
    graph <- W
  .data$time <- as.numeric(factor(.data$year))
  .data$time2 <- .data$time
  model <- inla(y0 ~ offset(log(y0_hat))
    + f(i, model = "besagproper2", graph = graph)
    , family = "poisson"
    , data = .data
    , control.predictor = list(link = 1)
    , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
      , config = TRUE
    )
  )
  #summary(model)
  .data <- append_results(model, .data, nboot)
  .data$method <- "sx_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  return(.data)
}
```

inla ar
```{r}
fit_arx <- \(.data
  , nboot = 200, compute_we = TRUE
) {
  t0 <- Sys.time()
  .data$time <- as.numeric(factor(.data$year))
  model <- inla(y0 ~ offset(log(y0_hat))
    + f(i, model = "iid", group = time, control.group = list(model = "ar1"))
    , family = "poisson"
    , data = .data
    , control.predictor = list(link = 1)
    , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
      , config = TRUE
    )
  )
  #summary(model)
  .data <- append_results(model, .data, nboot)
  .data$method <- "arx_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  return(.data)
}
```
rirw
```{r}
#.data <- filter(placebo_dt, replication == 2)
.data <- NULL
fit_rirw_inla <- \(.data
  , nboot = 200
) {
  t0 <- Sys.time()
  .data_inla <- .data %>%
    mutate(i1 = i
      , i2 = i + max(.data$i)
      , t1 = as.numeric(factor(year))
    )

  model <- inla(y0 ~ offset(log(n))
    + f(t1, model = "rw1")
    + f(i1, model = "iid")
    , family = "poisson"
    , data = .data_inla
    , control.predictor = list(link = 1)
    , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
      , config = TRUE
    )
  )
  summary(model)
  .data <- append_results(model, .data, nboot)
  .data$method <- "me_rirw_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  return(.data)
}
```

mixed effect with inla 
```{r}
fit_me_inla <- \(.data
  , nboot = 200
) {
  t0 <- Sys.time()
  .data_inla <- .data %>%
    mutate(i1 = i
      , i2 = i + max(.data$i)
      , t1 = as.numeric(factor(year))
    )

  model <- inla(y0 ~ offset(log(n))+ t1
    + f(i1, model = "iid2d", n = 2 * max(.data$i), constr = TRUE)
    + f(i2, t1, copy = "i1")
    , family = "poisson"
    , data = .data_inla
    , control.predictor = list(link = 1)
    , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
      , config = TRUE
    )
  )
  summary(model)
  .data <- append_results(model, .data, nboot)
  .data$method <- "me_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  return(.data)
}
```


mixed-effects
```{r}
library(lme4)

#fm <- formula(Y0 ~ offset(log(n)) + x + (x - 1 | id) + (1 | fyr))
fm <- formula(y0 ~ offset(log(n)) + scale(year) + (scale(year) | i))

boot_me <- \(.data, nboot = 200) {
  lapply(1:nboot, \(i) {
    .data$wts <- NULL
    .wdata <- left_join(
      .data
      , data.frame(i = unique(.data$i), wts = bb(n_distinct(.data$i)))
      , by = "i"
    )
    .wdata %>% mutate(wts = .wdata$wts / sum(.wdata$wts) * nrow(.wdata)) %>%
      impute_me
  }) %>%
    do.call("cbind", .)
}

impute_me <- \(.data) {
  if (is.null(.data$wts)) .data$wts <- 1
  glmer(fm
    , family = "poisson"
    , .data, weights = wts
  ) %>% predict(.data, type = "response")
}


fit_me <- \(.data, nboot = 200) {
  t0 <- Sys.time()
  .data$y0_hat <- .data %>% impute_me
  .data$y0_post <- .data %>% boot_me(nboot)
  .data$y0_sd <- apply(.data$y0_post, 1, sd)
  .data$eta_mean <- log(.data$y0_hat)
  .data$eta_sd <- apply(log(.data$y0_post), 1, sd)
  .data$y0_pi <- with(.data, pi_poilog(Y, eta_mean, eta_sd))
  .data[, c("y0_lower", "y0_upper")] <-
    with(.data, ci_poilog(eta_mean, eta_sd))
  .data$method <- "me"
  t1 <- Sys.time()
  print(t1 - t0)
  .data
}

filter(placebo_dt, replication == 1) %>% fit_me(2) %>% score
filter(placebo_dt, replication == 2) %>% fit_me(2) %>% score
#.data %>% impute_me
#.data %>% boot_me(3)
#.data %>% fit_me(2) %>% filter(is.na(y0)) %>% score
#.data %>% fit_me(3) %>% filter(is.na(y0)) %>% score
```


```{r}
library(fixest)
boot_etwfe <- \(nb = nboot) {
  mclapply(1:nb, \(i) {
    bdt <- left_join(
      dat
      , data.frame(id = unique(dat$id), wts = bb(length(unique(dat$id))))
      , by = "id"
    ) %>% mutate(wts = wts / sum(wts) * nrow(dat))
    suppressMessages(
      fepois(
        Y0 ~ 1 | cohort[x] + time[x]
        , vcov = ~ id, offset = ~ log(n)
        , bdt, weights = ~ wts
      ) %>% predict(bdt, type = "reponse")
    )
  }, mc.cores = 20)
}

fit_etwfe <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  model <- suppressMessages(
    fepois(Y0 ~ 1 | cohort[x] + time[x]
      , dat, vcov = ~ id, offset = ~ log(n)
    )
  )
  dat$Y0.mean <-  predict(model, dat, type = "reponse")

  dat[, paste0("Y0.b", 1:nboot)] <- boot_etwfe(n_boot)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "etwfe"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_etwfe(dat)
```

Extended TWFE 
```{r}
library(fixest)
boot_etwfe <- \(nb = nboot) {
  mclapply(1:nb, \(i) {
    bdt <- left_join(
      dat
      , data.frame(id = unique(dat$id), wts = bb(length(unique(dat$id))))
      , by = "id"
    ) %>% mutate(wts = wts / sum(wts) * nrow(dat))
    suppressMessages(
      fepois(
        Y0 ~ 1 | cohort[x] + time[x]
        , vcov = ~ id, offset = ~ log(n)
        , bdt, weights = ~ wts
      ) %>% predict(bdt, type = "reponse")
    )
  }, mc.cores = 20)
}

fit_etwfe <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  model <- suppressMessages(
    fepois(Y0 ~ 1 | cohort[x] + time[x]
      , dat, vcov = ~ id, offset = ~ log(n)
    )
  )
  dat$Y0.mean <-  predict(model, dat, type = "reponse")

  dat[, paste0("Y0.b", 1:nboot)] <- boot_etwfe(n_boot)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "etwfe"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_etwfe(dat)
```



Pooled Poisson 
```{r}
boot_pois <- \(nb = nboot) {
  mclapply(1:nb, \(i) {
    bdt <- left_join(
      dat
      , data.frame(id = unique(dat$id), wts = bb(length(unique(dat$id))))
      , by = "id"
    ) %>% mutate(wts = wts / sum(wts) * nrow(dat))

    glm(Y0 ~ x + offset(log(n))
      , family = "poisson"
      , bdt, weights = wts
    ) %>% predict(bdt, type = "reponse")
  }, mc.cores = 20)
}

fit_pois <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  dat$xdm <- resid(lm(x ~ cohort + time, dat))
  model <- glm(Y0 ~ x + offset(log(n))
    , family = "poisson", dat
  )
  dat$Y0.mean <-  predict(model, dat, type = "reponse")

  dat[, paste0("Y0.b", 1:nboot)] <- boot_pois(n_boot)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "pois"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_pois(dat)
```

mixed-effects
```{r}
library(lme4)
boot_me <- \(nb = nboot) {
  mclapply(1:nb, \(i) {
    bdt <- left_join(
      dat
      , data.frame(id = unique(dat$id), wts = bb(length(unique(dat$id))))
      , by = "id"
    ) %>% mutate(wts = wts / sum(wts) * nrow(dat))

    glmer(Y0 ~ offset(log(n)) + x + (x - 1 | id) + (1 | fyr)
      , family = "poisson"
      , bdt, weights = wts
    ) %>% predict(bdt, type = "reponse")
  }, mc.cores = 20)
}

fit_me <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  model <- glmer(Y0 ~ offset(log(n)) + x + (x - 1 | id) + (1 | fyr)
    , family = "poisson"
    , dat
  )
  dat$Y0.mean <-  predict(model, dat, type = "reponse")

  dat[, paste0("Y0.b", 1:nboot)] <- boot_me(n_boot)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "me"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}

fit_me(dat)
```

mixed-effects (conditional on )
```{r}
fit_me_inla <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  model <- inla(Y0 ~ x + offset(log(n))
    + f(id, x, model = "iid")
    + f(fyr, model = "iid")
    , family = "poisson"
    , data = dat
    , control.predictor = list(link = 1)
    , control.compute = list(config = TRUE)
  )
  ps <- inla.posterior.sample(n_boot, model)
  y_pred <- exp(inla.posterior.sample.eval("Predictor", ps))
  # y_pred <- apply(y_pred, 1:2, \(l) rpois(1, l))

  dat[, paste0("Y0.b", 1:nboot)] <- y_pred
  dat$Y0.mean   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, mean)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "me_inla"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_me_inla(dat)
```

```{r}
fit_sp <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  dat$i <- dat$id
  model <- inla(Y0 ~ x + offset(log(n))
    + f(id, x, model = "iid")
    + f(fyr, model = "iid")
    + f(i, x, model = "besag", graph = graph)
    , family = "poisson"
    , data = dat
    , control.predictor = list(link = 1)
    , control.compute = list(config = TRUE)
  )
  ps <- inla.posterior.sample(n_boot, model)
  y_pred <- exp(inla.posterior.sample.eval("Predictor", ps))
  # y_pred <- apply(y_pred, 1:2, \(l) rpois(1, l))

  dat[, paste0("Y0.b", 1:nboot)] <- y_pred
  dat$Y0.mean   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, mean)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "sp"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_sp(dat)
```

```{r}
fit_tp <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  dat$i <- dat$id
  model <- inla(Y0 ~ x + offset(log(n))
    + f(id, x, model = "iid")
    + f(fyr, model = "iid")
    + f(i, model = "iid", group = time, control.group = list(model = "ar1"))
    , family = "poisson"
    , data = dat
    , control.predictor = list(link = 1)
    , control.compute = list(config = TRUE)
  )
  ps <- inla.posterior.sample(n_boot, model)
  y_pred <- exp(inla.posterior.sample.eval("Predictor", ps))
  # y_pred <- apply(y_pred, 1:2, \(l) rpois(1, l))

  dat[, paste0("Y0.b", 1:nboot)] <- y_pred
  dat$Y0.mean   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, mean)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "tp"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_tp(dat)
```

```{r}
fit_st <- \(dat, n_boot = nboot) {
  t0 <- Sys.time()
  dat$i <- dat$id
  model <- inla(Y0 ~ x + offset(log(n))
    + f(id, x, model = "iid")
    + f(fyr, model = "iid")
    + f(i, x, model = "besag", graph = graph
      , group = time, control.group = list(model = "ar1")
    )
    , family = "poisson"
    , data = dat
    , control.predictor = list(link = 1)
    , control.compute = list(config = TRUE)
  )
  ps <- inla.posterior.sample(n_boot, model)
  y_pred <- exp(inla.posterior.sample.eval("Predictor", ps))
  # y_pred <- apply(y_pred, 1:2, \(l) rpois(1, l))

  dat[, paste0("Y0.b", 1:nboot)] <- y_pred
  dat$Y0.mean   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, mean)
  dat$Y0.sd   <-  apply(dat[, paste0("Y0.b", 1:n_boot)], 1, sd)

  dat$method <- "st"
  t1 <- Sys.time()
  print(t1 - t0)
  dat
}
fit_st(dat)
```


```{r}
load("data/gs")
graph <- gs
set.seed(0203)
nboot <- 400

fit_all <- \(dat) {
  etwfe   <- fit_etwfe(dat)
  pois    <- fit_pois(dat)
  me      <- fit_me(dat)
  me_inla <- fit_me_inla(dat)
  sp      <- fit_sp(dat)
  tp      <- fit_tp(dat)
  st      <- fit_st(dat)
  bind_rows(etwfe, pois, me, me_inla, sp, tp, st, .id = "o")
}

colnames(fit_all(dat))

```


```{r}
start_time <- Sys.time()
lapply(names(dt_list), \(name) {
  print(name)
  dt <- dt_list[name][[1]] %>% pre_dat
  rep <-  tryCatch(
    fit_all(dt)
    ,  error = function(c) NULL
  )
  saveRDS(rep, file = paste0("data/tmp/placebo_rep_", name))
})
end_time <- Sys.time()
end_time - start_time
```

```{r}
list_files <- list.files("data/tmp", "placebo_rep_", full.names = TRUE)
list_dat   <- lapply(list_files, \(fl) readRDS(fl))
length(list_dat)
library(data.table)
fits      <- rbindlist(list_dat, idcol = "replication")
saveRDS(fits, file = paste0("data/placebo_1124.rds"))
```

