

```{r}
options(digitis = 3)
options(scipen = 10^5)
options(help_type = "html")
library(data.table)
library(tidyverse)
library(parallel)
#load R functions
sapply(list.files("R/", ".r", full.names = TRUE), source)
set.seed(0203)
options(scipen = 10^6)


library(INLA)
library(fixest)
library(parallel)
library(profvis)
```

DATA
```{r}
placebo_dt <- readRDS("data/placebo_dt_prop.rds")
load("data/W")
rownames(W) <- NULL
```

```{r}
colnames(placebo_dt)
placebo_dt$y0_hat <- NULL
placebo_dt$cpr <- NULL


#forest
set.seed(0203)
start <- Sys.time()
placebo_dt_imputed1 <- mclapply(1:40, \(r) {
  dt <- filter(placebo_dt, replication == r) #received data
  dt$cpr <- dt %>% expandx %>% select(cpr) %>% unlist #compute propensity
  dt <- dt %>% impute_forest(200) #
  dt$cpr <- NULL
  return(dt)
}, mc.cores = 18) %>%
  bind_rows
end <- Sys.time()
print(end - start)

start <- Sys.time()
placebo_dt_imputed2 <- mclapply(1:40, \(r) {
  dt <- filter(placebo_dt, replication == r) #received data
  dt$cpr <- dt %>% expandx %>% select(cpr) %>% unlist #compute propensity
  dt <- dt %>% impute_forest(200, exvar = FALSE) #
  dt$cpr <- NULL
  return(dt)
}, mc.cores = 18) %>%
  bind_rows
end <- Sys.time()
print(end - start)


placebo_dt_imputed1 %>%
  filter(is.na(y0)) %>%
  group_by(replication, urb) %>%
  summarise(mse = mean((y - y0_hat)^2) %>% sqrt) %>%
  group_by(urb) %>%
  summarise(mean(mse), median(mse), sd(mse))

placebo_dt_imputed2 %>%
  filter(is.na(y0)) %>%
  group_by(replication, urb) %>%
  summarise(mse = mean((y - y0_hat)^2) %>% sqrt) %>%
  group_by(urb) %>%
  summarise(mean(mse), median(mse), sd(mse))

with(filter(placebo_dt, replication ==1), tapply(i, urb, n_distinct))
```



Inferece for forest
```{r}
placebo_dt <- readRDS("data/placebo_dt_prop_rfimputed.rds")
```

This  works beutifully
caveats:
1. a bit of undecoverage in large metro areas
1.1. tweek the propensity model? 
1.2. number of trees to make inference?
2. logarithmic score is not working
2.1. let those computation to the very end (not really needed)
2.2. and replace for non parametric density estiamtion or logpoisson
3. work a bit mmore on time and cpp


```{r}
#forest
set.seed(0203)
forest_fit <- mclapply(1:100, \(r) {
  .data <- filter(placebo_dt, replication == r)
  .data %>% inference_forest(nboot = 400)
}, mc.cores = 18) %>%
  bind_rows


forest_fit %>%
  filter(is.na(y0)) %>%
  score %>%
  group_by(replication, urb) %>%
  summ_score %>%
  group_by(urb) %>%
  summarize_if(is.numeric, fmean) %>% t

forest_fit$method <- "forest"

saveRDS(forest_fit, "data/forest_fit_prop.rds")
```

```{r}
.data <- filter(placebo_dt, replication == 1)
.data$wts <- 1
fm <- formula(y0 ~ offset(log(y0_hat)) - 1 + (1 | i))
#fm <- formula(y0 ~ offset(log(n)) - 1 + (1 | i))

fit <- glmer(fm
  , family = "poisson"
  , .data
  , weights = wts
  , control = glmerControl(optimizer = "bobyqa")
)

fit <- glm(y0 ~ offset(log(y0_hat)) - 1
  , family = "quasipoisson"
  , .data
  , weights = wts
)
summary(fit)


cor(.data$Y[is.na(.data$y0)], .data$y0_hat[is.na(.data$y0)])
cor(.data$Y[is.na(.data$y0)]
  , predict(fit, .data, type = "response")[is.na(.data$y0)]
)
#filter(placebo_dt, replication == 1) %>% fit_me(2)
```



#ME
with predictor as offset

```{r}
mex_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_me
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
mex_fit$method <- "mex"
saveRDS(mex_fit, "data/mex_fit_prop.rds")
```

AR(1)
```{r}
t0 <- Sys.time()
set.seed(0203)
arx_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_arx
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(arx_fit, "data/arx_fit_prop.rds")
```

#spatio temporal x
```{r}
t0 <- Sys.time()
set.seed(0203)
spx_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_spx
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)

saveRDS(spx_fit, "data/spx_fit_prop.rds")
```


***#WARNING***
This changes the offset to log(y0_hat) instead of log(n)
```{r}
impute_fe <- \(.data) {
  if (is.null(.data$wts)) .data$wts <- 1
  fepois(fm
    , vcov = ~ i, offset = ~ log(y0_hat)#log(n)
    , .data, weights = .data$wts
  ) %>% predict(.data, type = "response")
}

```

#Fixed effects
```{r}
#filter(placebo_dt, replication == 1) %>% impute_fe
#filter(placebo_dt, replication == 1) %>% boot_fe(impute_fe, 5)

t0 <- Sys.time()
set.seed(0203)
fm <- formula(y0 ~ 1 | i + year)
twfe_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_fe(200)
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
twfe_fit$method <- "twfex"
saveRDS(twfe_fit, "data/twfex_fit_prop.rds")

# this is alrread a CRE model
# we are intrest in the effect of intervention,
# worried about heterogeneity
# so we include a cluster level average of the covariate (which is the same as the cohort indicator)

t0 <- Sys.time()
set.seed(0203)
fm <- formula(y0 ~ 1 | start_year + year)
etwfe_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_fe(200)
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
etwfe_fit$method <- "etwfex"
saveRDS(etwfe_fit, "data/etwfex_fit_prop.rds")
```


```{r}
.graph <- W_est(.data, W)
.data <- filter(placebo_dt, replication == 1)
.data$time <- as.numeric(factor(.data$year))
model <- inla(y0 ~ offset(log(y0_hat))  - 1
  + f(i, model = "besagproper2", graph = .graph
    , group = time, control.group = list(model = "ar1")
  )
  , family = "poisson"
  , data = .data
  , control.predictor = list(link = 1)
  , control.compute = list(dic = TRUE, cpo = TRUE, waic = TRUE
    , config = TRUE
  )
)
summary(model)


```


ME inla
```{r}
t0 <- Sys.time()
set.seed(0203)
me_inla_fit <- mclapply(1:400, \(r) {
  filter(placebo_dt, replication == r) %>%
    fit_me_inla
}, mc.cores = 20) %>%
  bind_rows
t1 <- Sys.time()
print(t1 - t0)
me_inla_fit$method <- "me_inla"

saveRDS(me_inla_fit, "data/fit_me_inla.rds")
```