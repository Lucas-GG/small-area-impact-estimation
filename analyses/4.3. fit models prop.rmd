

```{r}
options(digitis = 3)
options(scipen = 10^5)
options(help_type = "html")
library(data.table)
library(tidyverse)
library(parallel)
#load R functions
sapply(list.files("R/", ".r", full.names = TRUE), source)
set.seed(0203)
options(scipen = 10^6)
```

DATA
```{r}
placebo_dt <- readRDS("data/placebo_dt_prop.rds")
placebo_dt <- as.data.table(placebo_dt, key = c("replication", "i", "year"))
keep_cols <- setdiff(names(placebo_dt)
  , c("y0_hat", "cpr")
)
placebo_dt <- placebo_dt[, ..keep_cols]
dim(placebo_dt)
```


This takes 10 hours
```{r}
#forest
set.seed(0203)
start <- Sys.time()
placebo_dt_forest <- mclapply(1:200, \(r) {
  dt <- placebo_dt[replication == r, ] #received data
  dt <- dt %>%
    impute_forest(40, ncores = 4) %>%
    inference_forest(40, nboot = 200, ncores = 4)
}, mc.cores = 5) %>%
  bind_rows
end <- Sys.time()
print(end - start)
#saveRDS(placebo_dt_forest, "data/forest_fit_prop_gb.rds")
```
correct point estimate
```{r}
start <- Sys.time()
forest_imp <- mclapply(1:200, \(r) {
  dt <- placebo_dt[replication == r, ]
  dt <- dt %>% impute_forest(200, ncores = 1)
}, mc.cores = 20) %>%
  bind_rows
end <- Sys.time()
print(end - start)
```
```{r}
#dim(forest_imp)
#forest_fit <- readRDS("data/forest_fit_prop_gb.rds")
#forest_fit$y0_hat <- NULL
#dim(forest_fit)

#forest_fit <- left_join(forest_fit
#  , forest_imp[, .(i, year, replication, y0_hat)]
#  , by = c("i", "year", "replication")
#)
#saveRDS(forest_fit, "data/forest_fit_prop_gb200.rds")
```


```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")
wnd <- 6 # 6
tb <- forest_fit %>%
  filter(is.na(y0)) %>%
  filter(event_time < wnd, start_year <= max(year) - wnd) %>% #constant cohort
  eval %>%
  score %>%
  group_by(replication, urb) %>%
  summ_score %>%
  group_by(urb) %>%
  summarize_if(is.numeric, fmean)
tb[, 1:10]
tb[, 11:18]


y0_post_cols <- grep("y0_post", names(forest_fit), value = TRUE)
y0_post <- forest_fit[is.na(y0), ..y0_post_cols] %>% as.matrix
cor(forest_fit[is.na(y0), ]$y0_hat, rowMeans(y0_post, na.rm = TRUE))
cor(forest_fit[is.na(y0), ]$y0_hat, forest_fit[is.na(y0), ]$y)
cor(rowMeans(y0_post, na.rm = TRUE), forest_fit[is.na(y0), ]$y)
```
If we let enough trees when constructing the CI, then the mean posterior and conicide with the estiamtion at weight 1.


RE
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")
me_fit <- forest_fit
start <- Sys.time()
me_fit <- mclapply(1:200, \(r) {
  dt <- me_fit[replication == r, ]
  dt <- dt %>% bbx_inference(impute_fun = impute_me, fm = fm_me)
}, mc.cores = 20) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(me_fit, "data/me_fit_200.rds")
```
evaluate
```{r}
#me_fit <- readRDS("data/me_fit_200.rds")
length(unique(me_fit$replication))
wnd <- 6 # 6
tb <- me_fit %>%
  filter(is.na(y0)) %>%
  filter(event_time < wnd, start_year <= max(year) - wnd) %>% #constant cohort
  eval %>%
  score %>%
  group_by(replication, urb) %>%
  summ_score %>%
  group_by(urb) %>%
  summarize_if(is.numeric, fmean)
tb[, 1:10]
tb[, 11:18]
```


IME
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
ime_dt <- lapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  m  <- dt %>% combx_inla(20, 5, fit_fun = fit_ime)
  dt <- impute_inla(dt, m)
  dt
}) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(ime_dt, "data/ime_m200.rds")
```

AR(1)
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")
ar_fit <- forest_fit
start <- Sys.time()
ar_dt <- lapply(1:200, \(r) {
  dt <- ar_fit[replication == r, ]
  m  <- dt %>% combx_inla(20, 5)
  dt <- impute_inla(dt, m)
  dt
}) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(ar_dt, "data/ar_m200.rds")
```

Spatio Temporal
```{r}
load("data/W")
rownames(W) <- NULL
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")
#dt <- filter(forest_fit, replication == 1)

start <- Sys.time()
spt_dt <- lapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  graph <<- W_est(dt, W)
  m  <- dt %>% combx_inla(20, 5, fit_fun = fit_spt)
  dt <- impute_inla(dt, m)
  dt
}) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(spt_dt, "data/spt_m200.rds")
```



```{r}
fit <- spt_dt#twfe_fit
length(unique(fit$replication))
wnd <- 6 # 6
tb <- fit %>%
  filter(is.na(y0)) %>%
  filter(event_time < wnd, start_year <= max(year) - wnd) %>%
  filter(!is.na(y0_post_1)) %>%
  eval %>%
  score %>%
  group_by(replication, urb) %>%
  summ_score %>%
  group_by(urb) %>%
  summarize_if(is.numeric, fmean)
tb[, 1:10]
tb[, 11:18]
```




#Fixed effects
TWFE
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
twfe_fit <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  dt <- dt %>% bbx_inference(impute_fun = impute_fe, fm = fm_twfe)
}, mc.cores = 20) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(twfe_fit, "data/twfe_fit_200.rds")
```

ETWFE
```{r}
#forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
etwfe_fit <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  dt <- dt %>% bbx_inference(impute_fun = impute_fe, fm = fm_etwfe)
}, mc.cores = 20) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(etwfe_fit, "data/etwfe_fit_200.rds")
```


#Fixed effects no x
TWFE
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
fit <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  dt <- dt %>% bbx_inference_nox(impute_fun = impute_fe, fm = fm_twfe)
}, mc.cores = 20) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(fit, "data/twfe_nox_200.rds")
```


ETWFE
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
fit <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  dt <- dt %>% bbx_inference_nox(impute_fun = impute_fe, fm = fm_etwfe)
}, mc.cores = 20) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(fit, "data/etwfe_nox_200.rds")
```

*** INLA NO X ***
IME
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
idt <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  dt  <- dt |> impute_inla(fit_fun = fit_ime)
  dt
}, mc.cores = 5) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(idt, "data/pure_ime_200.rds")
```

AR(1)
```{r}
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")
start <- Sys.time()
idt <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  dt  <- dt |> impute_inla(fit_fun = fit_ar)
  dt
}, mc.cores = 5) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(idt, "data/pure_ar_200.rds")
```

Spatio Temporal
```{r}
load("data/W")
rownames(W) <- NULL
forest_fit <- readRDS("data/forest_fit_prop_gb200.rds")

start <- Sys.time()
idt <- mclapply(1:200, \(r) {
  dt <- forest_fit[replication == r, ]
  graph <<- W_est(dt, W)
  dt  <- dt |> impute_inla(fit_fun = fit_spt)
  dt
}, mc.cores = 4) %>%
  bind_rows
end <- Sys.time()
print(end - start)
saveRDS(idt, "data/pure_spt_200.rds")
```






















MISC MISC MISC MISC MISC MISC MISC MISC MISC MISC MISC 
MISC MISC MISC MISC MISC MISC MISC MISC MISC MISC MISC 


Interval inference
So intrestin stream, but so far too wide
```{r}
min(placebo_dt$start_year)
colnames(placebo_dt)
keep_cols <- setdiff(names(placebo_dt), c("y0_hat", "cpr"))
placebo_dt <- placebo_dt[, ..keep_cols]
length(unique(placebo_dt$replication))

#forest
set.seed(0203)
start <- Sys.time()
placebo_dt_foresti <- mclapply(1:20, \(r) {
  dt <- placebo_dt[replication == r, ] #received data
  dt <-  dt %>%
    impute_forest(400, ncores = 4,  exvar = TRUE, interval = TRUE)
}, mc.cores = 5) %>%
  bind_rows
end <- Sys.time()
print(end - start)

m <- placebo_dt_foresti[, .SD
  , .SDcols = grep("y0_post_", names(placebo_dt_forest), value = TRUE)
] %>%
  is.na %>%
  apply(2, mean)

s <- m > 0
names(which(s))
placebo_dt_foresti[, names(which(s))] <- NULL

saveRDS(placebo_dt_foresti, "data/forest_fit_interval.rds")
```


```{r}
#forest_fit <- readRDS("data/forest_fit_prop_gb.rds")
forest_fit <- placebo_dt_foresti

#dt <- filter(forest_fit, replication == 1)
#dt <- filter(dt, is.na(y0))
#eval(dt) %>% summary
range(dt$year)

wnd <- 6 # 6
tb <- forest_fit %>%
  filter(is.na(y0)) %>%
  filter(event_time < wnd, start_year <= max(year) - wnd) %>% #constant cohort
  eval(pi_type = "interval") %>%
  score %>%
  group_by(replication, urb) %>%
  summ_score %>%
  group_by(urb) %>%
  summarize_if(is.numeric, fmean)
tb[, 1:10]
tb[, 11:18]


y0_post_cols <- grep("y0_post", names(forest_fit), value = TRUE)
y0_post <- forest_fit[is.na(y0), ..y0_post_cols] %>% as.matrix
cor(forest_fit[is.na(y0), ]$y0_hat, rowMeans(y0_post, na.rm = TRUE))
cor(forest_fit[is.na(y0), ]$y0_hat, forest_fit[is.na(y0), ]$y)
cor(rowMeans(y0_post, na.rm = TRUE), forest_fit[is.na(y0), ]$y)
```
