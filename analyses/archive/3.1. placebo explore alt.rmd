```{r}
options(digitis = 3)
options(scipen = 10^5)
options(help_type = "html")

library(parallel)
library(tidyverse)

#load R functions
sapply(list.files("R/", ".r", full.names = TRUE), source)
library(data.table)

library(missRanger)
library(ranger)
library(rpart)
```

Select data
```{r}
df <-  readRDS('data/ldat.rds')
# the data is long with 2 outcomes, select one
df <- df[df$otyp == "IP" & df$opop == "youth", ]
df$yr1[df$yr1 == 9999] <- Inf #max(df$year) + 1
dim(df)
summary(df)
colnames(df)

#add lat an lon
load("data/hmap")
coord <- as.data.frame(sp::coordinates(hmap))
colnames(coord) <- c("lon", "lat")
coord$id <- as.integer(rownames(coord))
df <- left_join(df, coord, by = "id")
df <- arrange(df, i, t)

table(df$i == as.numeric(factor(df$i)))
# the dataset is prepare to analyze hospital activity
# replacing here by suicide
df <- df %>%
  mutate(
    Y = S
    , Y0 = ifelse(as.numeric(year >= yr1), NA, S)
    , start_year = yr1
    , E = sum(S) / sum(P) * P
    , time = year - 1998
    , SMR = Y / E
    , n = P
    , st = as.factor(statefips)
    , urb = as.factor(urb13)
    , fid = as.factor(i)
    , fyr = as.factor(year)
    , across(where(is.character), as.factor)
    , cfip = COUNTYFIPS
  )

colnames(df)
dt <- df %>%
  select(cfip, i, year, Y, n#E, n
    , start_year
    , yr1
    , urb
    , st, HSA_name, region,  division
    , TribalStatus, AIAN
    , urb
    , lon, lat
    , uemp, pov, mhinc
  )
dt %>% summary
head(dt[is.na(dt$uemp), ])

dim(df)
length(unique(df$i)) * length(unique(df$year))

dt[, c("AIAN", "uemp", "pov", "mhinc")] <- dt %>%
  missRanger %>%
  select(AIAN, uemp, pov, mhinc)

head(dt[dt$cfip == "46113", ])
```


Simulate intervention by shuffling around the start year
True intervention observation are filtered out (where??)
```{r}
sapply(list.files("R/", ".r", full.names = TRUE), source)
table(dt$year)
tapply(dt$i, dt$yr1, \(x) length(unique(x)))
with(dt, table(year < yr1))

#True intervention observation are filtered out
dt0 <- subset(dt, year < yr1)

dt0 %>% shuffle_start %>% with(., table(year < start_year))
dt0 %>% shuffle_start %>% shuffle_start %>% with(., table(year < start_year))
dt0 %>% shuffle_start %>% add_avg

#mixed effect
dt0 %>%
  shuffle_start %>%
  add_avg %>%
  impute_me %>%
  assess_impute

#e-twfe
dt0 %>%
  shuffle_start %>%
  add_avg %>%
  impute_etwfe %>%
  assess_impute

#forest
dt0 %>%
  shuffle_start %>%
  impute_forest(75, k = 1,  min_bucket = 7, max_depth = 30) %>%
  assess_impute

dts <- list()
dts[[1]] <- dt0 %>%
  shuffle_start %>%
  impute_forest(75, k = 1,  min_bucket = 7, max_depth = 30)

summary(dts[[1]])
summary(dts[[2]])
summary(dts[[3]])

lapply(2:3, \(i) {
  dts[[i]] <<- dts[[i - 1]] %>%
    #shuffle_start %>%
    impute_boost_forest(40, k = 1,  min_bucket = 7, max_depth = 30)
})
sapply(dts, assess_impute) %>% t

with(filter(dts[[5]], year > start_year), plot(Y, y0_hat))
```




TRMF (Temporally Regularized Matrix Factorization)
```{r}

library(TRMF)
V[1:2, 1:2] <- NA
obj <- create_TRMF(V)
obj <- TRMF_columns(obj, reg_type = "nnls", lambda = 1)
obj <- TRMF_trend(obj, numTS = 2, order = 2, lambdaD = 1)
out <- train(obj)
summary(out)
plot(out)
resid(out)
fitted(out)
impute_TRMF(out)
coef(out)
Fm <- out$Factors$Fm
Xm <- out$Factors$Xm 
predict(out)

help(TRMF_columns)
```

Non-negative matrix factorization
```{r}
library(NMF)
#library(devtools)
#install_github('linxihui/NNLM')

#library(NNLM)
#help(nnlm)
#m <- nnmf(V, loss = "mkl")
#with(m, W %*% H)

impute_nnmf <- \(.data) {
  .data %>%
    mutate(pi0 = y0 / n * 10^5) %>%
    select(i, year, pi0) %>%
    spread(year, pi0) %>%
    select(- i) %>%
    as.matrix %>%
    nnmf(k = 1, loss = "mkl", method = "lee"
      , alpha = c(10, 0, 0), beta = c(10, 0, 0)
    ) %>%
    with(., W %*% H) %>%
    as.data.frame %>%
    rownames_to_column("i") %>%
    gather(year, pi0, - i) %>% 
    arrange(i, year) %>%
    mutate(i = as.integer(i), year = as.integer(year)) %>%
    left_join(.data, ., by = c("i", "year")) %>%
    mutate(y0_hat = pi0 * n / 10^5)
}
```


```

```

```{r}

```

```{r}
dt0 %>%
  shuffle_start %>%
  #impute_nnmf %>%
  impute %>%
  assess_impute

mclapply(1:200, \(i) {
  dt0 %>%
    shuffle_start %>%
    #impute_nnmf %>%
    impute %>%
    assess_impute
}, mc.cores = 20
) %>% do.call("rbind", .) %>% apply(2, mean, na.rm = TRUE)
```




Consider subsample of columns?
Does sqrt citeria do much better?
Is it workign in its own temrs??

W & B uses
N for the count 
and Y for N/v






```{r}
#dt <- dplyr:::select(df, c(id, time, SMR,  E, n, Y, Y0
#    , st, AIAN, urb))

prepare_data_ranger <- \(dt_tmp = dt_list[[1]]) {
  dt_tmp$last <- with(dt_tmp, apply(cbind(s, yr1), 1, min))
  dt_tmp$last[dt_tmp$last == Inf] <- max(dt_tmp$year)
  dt_tmp <- dt_tmp %>%
    group_by(id) %>%
    mutate(
      mean_SMR = mean(SMR, na.rm = TRUE)
      , slope_SMR = coef(lm(SMR ~ time))[2]
      , mean5_SMR = mean(if_else(year >= last - 5, SMR, NA), na.rm = TRUE)
      , mean10_SMR = mean(if_else(year >= last - 10, SMR, NA), na.rm = TRUE)
    ) %>%
    ungroup

  dt_tmp <- dt_tmp %>%
    select(SMR
      , fid
      , fyr, time
      , st, HSA_name, region,  division
      , TribalStatus, AIAN
      , urb
      , mean_SMR, mean5_SMR, mean10_SMR, slope_SMR
      , lon, lat
      , E, n 
      , O
    )
  dt_tmp
}
head(prepare_data_ranger(dt_list[[2]]))
```

#tunning random forest for the task at hand
```{r}
dt_tmp <- prepare_data_ranger(dt_list[[2]])
colnames(dt_tmp)

library(tuneRanger)
library(mlr)
# A mlr task has to be created in order to use the package
task <- makeRegrTask(
  data = dt_tmp[dt_tmp$O == 1, ]
  , target = "SMR"
  #, blocking = dt_tmp$fid[dt_tmp$O == 1]
)
# Estimate runtime
estimateTimeTuneRanger(task)

# Tuning
#https://arxiv.org/abs/1804.03515
set.seed(0203)
res <- tuneRanger(task
  , num.trees = 1000
  , iters.warmup = 50
  , iters = 250
  , save.file.path = NULL
)
res
```

```{r}
dt_tmp <- prepare_data_ranger(dt_list[[1]])
mf <- ranger(SMR ~ .
  , data = dt_tmp[dt_tmp$O == 1, ]
  , importance = "impurity_corrected"
  , mtry = 19
  , min.node.size = 800
  , sample.fraction = 0.2
)

importance(mf)
mf$r.squared
mf$prediction.error
```



```{r}
start_time <- Sys.time()
dt_list_x <- mclapply(dt_list, \(dt_tmp) {
  dt_rng <- prepare_data_ranger(dt_tmp)
  ff <- ranger(SMR ~ .
    , data = dt_rng[dt_rng$O == 1, ]
    , mtry = 19
    , min.node.size = 800
    , sample.fraction = 0.2
  )
  dt_rng$x <- scale(predict(ff, dt_rng)$predictions)
  dt_rng
}, mc.cores = 20
)
end_time <- Sys.time()
end_time - start_time

saveRDS(dt_list_x, file = paste0("data/placebo_1124.rds"))

#should the forest predicted value be part of the epectation?
#dt_list_x <- readRDS(file = paste0("data/placebo.rds"))
#dt_list <- lapply(dt_list_x, \(dt_tmp) {
#    dt_tmp$SMR_old <- dt_tmp$SMR
#    dt_tmp$SMR <- dt_tmp$SMR_old / dt_tmp$x
#    dt_tmp$E_old <- dt_tmp$E
#    dt_tmp$E <- dt_tmp$E_old * dt_tmp$x
#    dt_tmp
#    }
#    )
#saveRDS(dt_list, file = paste0("data/placebo.rds"))
```
